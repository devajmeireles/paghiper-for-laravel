<!DOCTYPE html>
<html class="writer-html5" lang="pt_BR" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="AJ Meireles" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>Retorno Autom√°tico - PagHiper for Laravel</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/vs.min.css" />
        <link href="../../../css/style.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Retorno Autom\u00e1tico";
        var mkdocs_page_input_path = "recursos/pix/retorno.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/php.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/shell.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../..">
          <img src="../../../images/logo.png" class="logo" alt="Logo"/>
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">Boas-vindas</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Iniciando</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../iniciando/detalhes-tecnicos/">Detalhes T√©cnicos</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../iniciando/instalacao/">Instala√ß√£o</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Recursos</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="#">Boleto Banc√°rio</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../boleto/criando/">Criando</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../boleto/status/">Status</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../boleto/cancelando/">Cancelando</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../boleto/retorno/">Retorno Autom√°tico</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">PIX</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="../criando/">Criando</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../status/">Status</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../cancelando/">Cancelando</a>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" href="./">Retorno Autom√°tico</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Utilidades</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../utilidades/casts/">Casts</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Tratamento de Erros</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../erros/excessoes/">Excess√µes</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Reposit√≥rio</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../repositorio/contribuicao/">Contribui√ß√£o</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">PagHiper for Laravel</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" aria-label="Docs"></a> &raquo;</li>
          <li>Recursos &raquo;</li>
          <li>PIX &raquo;</li>
      <li class="breadcrumb-item active">Retorno Autom√°tico</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/devajmeireles/paghiper-for-laravel/blob/main/docs/docs/recursos/pix/retorno.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="retorno-automatico">Retorno Autom√°tico</h1>
<p><code>Paghiper for Laravel</code> oferece uma forma f√°cil de lidar com o retorno autom√°tico. O retorno autom√°tico da PagHiper 
ocorrer√° para a rota que voc√™ configurou no objeto <code>Basic</code>, no par√¢metro <code>$notification_url</code> na cria√ß√£o do PIX, 
ou para a rota definida via <a href="../../../iniciando/detalhes-tecnicos/">resolvedor</a>. Essa rota deve ser uma rota p√∫blica em sua 
aplica√ß√£o, e de prefer√™ncia que n√£o receba nenhum tratamento especial, por exemplo: middlewares, autentica√ß√£o, etc.</p>
<p>Supondo que voc√™ possui uma rota nomeada como <code>paghiper.notification</code> que aceita requisi√ß√µes <code>POST</code>, e que essa foi 
a rota utilizada, ent√£o isso ser√° suficiente:</p>
<pre><code class="language-php">use Illuminate\Http\Request;
use Illuminate\Support\Facades\Route;
use DevAjMeireles\PagHiper\Facades\PagHiper;

Route::post('/payment/notification', function (Request $request) {
    $notification = $request-&gt;input('notification_id'); // üëà enviado pelo PagHiper
    $transaction  = $request-&gt;input('transaction_id');  // üëà enviado pelo PagHiper

    $notification = PagHiper::pix()-&gt;notification($notification, $transaction);
})-&gt;name('paghiper.notification');
</code></pre>
<p>No exemplo acima, <code>$notification</code> ser√° um array com os dados da notifica√ß√£o.</p>
<h2 id="injetando-o-illuminatehttprequest">Injetando o <code>\Illuminate\Http\Request</code></h2>
<p>De forma auxiliar, voc√™ pode injetar uma inst√¢ncia de <code>\Illuminate\Http\Request</code> ao inv√©s de ter que definir 
manualmente os par√¢metros para o m√©todo <code>notification</code>:</p>
<pre><code class="language-php">use Illuminate\Http\Request;
use Illuminate\Support\Facades\Route;
use DevAjMeireles\PagHiper\Facades\PagHiper;

Route::post('/payment/notification', function (Request $request) {
    $notification = PagHiper::pix()-&gt;notification($request);
})-&gt;name('paghiper.notification');
</code></pre>
<p><code>PagHiper for Laravel</code> ir√° buscar os par√¢metros necess√°rios para a notifica√ß√£o automaticamente.</p>
<h3 id="cast-especial-pixnotification">Cast Especial: <code>PixNotification</code></h3>
<p>De forma especial para o retorno autom√°tico, <code>Paghiper for Laravel</code> oferece o cast <code>PixNotification</code>, que quando
utilizado ir√° mapear a resposta da PagHiper para uma classe de objeto contendo muitos m√©todos √∫teis:</p>
<pre><code class="language-php">use Illuminate\Http\Request;
use DevAjMeireles\PagHiper\Facades\PagHiper;
use Illuminate\Support\Facades\Route;
use DevAjMeireles\PagHiper\Enums\Cast; // üëà

Route::post('/payment/notification', function (Request $request) {
    $notification = PagHiper::pix(Cast::PixNotification) // üëà
        -&gt;notification($request);
})-&gt;name('paghiper.notification');
</code></pre>
<h3 id="metodos-disponiveis">M√©todos Dispon√≠veis:</h3>
<pre><code class="language-php">public function original(): Response
</code></pre>
<p>üëÜ resposta original, inst√¢ncia de <code>\Illuminate\Http\Client\Response</code></p>
<pre><code class="language-php">public function type(): string
</code></pre>
<p>üëÜ tipo da notifica√ß√£o, pode ser <code>billet</code> ou <code>pix</code></p>
<pre><code class="language-php">public function transactionId(): string
</code></pre>
<p>üëÜ id da transa√ß√£o</p>
<pre><code class="language-php">public function orderId(): string
</code></pre>
<p>üëÜ <code>$order_id</code> da transa√ß√£o</p>
<pre><code class="language-php">public function createDate(): Carbon
</code></pre>
<p>üëÜ data de cria√ß√£o do pix como inst√¢ncia de <code>\Illuminate\Support\Carbon</code></p>
<pre><code class="language-php">public function status(): string
</code></pre>
<p>üëÜ status da transa√ß√£o como string</p>
<pre><code class="language-php">public function pending(): bool
public function canceled(): bool
public function completed(): bool
public function paid(): bool
public function processing(): bool
public function refunded(): bool
</code></pre>
<p>üëÜ booleano para o status do pix</p>
<hr />
<p>Os demais m√©todos seguem a <a href="https://dev.paghiper.com/reference/notificacoes-automatica-de-status-retorno-automatico-pix" target="_blank">conven√ß√£o de nomes da PagHiper</a>:</p>
<pre><code class="language-php">public function dueDateTime(): \Illuminate\Support\Carbon
public function paidDate(): \Illuminate\Support\Carbon
public function valueCents(): int
public function valueFeeCents(): int
public function valueCentsPaid(): int
public function shippingPriceCents(): int
public function discountCents(): int
public function numCartItems(): int
public function dueDate(): \Illuminate\Support\Carbon
public function pixCode(): array
public function items(): array|\DevAjMeireles\PagHiper\DTO\Objects\Item
public function payer(): \DevAjMeireles\PagHiper\DTO\Objects\Payer
</code></pre>
<h2 id="metodo-especial-modelable">M√©todo Especial: <code>modelable</code></h2>
<p>De forma estrat√©gica, ao passar uma inst√¢ncia de um modelador do Laravel como <code>Payer</code> do PIX, o <code>order_id</code> na PagHiper receber√° uma refer√™ncia da classe e ID do modelador para que posteriormente no retorno autom√°tico voc√™ possa utilizar o m√©todo <code>modelable</code> para obter o modelador facilmente.</p>
<p>Essa abordagem far√° com que o <code>order_id</code> PIX fique, por exemplo, da seguinte maneira na PagHiper: <code>11|App\Model\User:1</code>, onde <code>11</code> √© o n√∫mero do <code>$order_id</code> que voc√™ especificou na cria√ß√£o da classe <code>Basic</code>. N√£o h√° preocupa√ß√£o enquanto a este formato, uma vez que o <code>order_id</code> do PIX √© para uso interno, e n√£o √© exibido ao cliente.</p>
<p>Dessa forma voc√™ ent√£o poder√° utilizar o m√©todo <code>modelable</code>:</p>
<pre><code class="language-php">use App\Models\User; // üëà
use DevAjMeireles\PagHiper\DTO\Objects\Basic;
use DevAjMeireles\PagHiper\DTO\Objects\Item;
use DevAjMeireles\PagHiper\Enums\Cast; // üëà
use DevAjMeireles\PagHiper\Facades\PagHiper;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Route;

// criando o boleto para o modelador User:1 üëá

$pix = PagHiper::pix()
    -&gt;create(
        Basic::make()
            -&gt;set('order_id', 1433)  
            -&gt;set('days_due_date', 2)  
            -&gt;set('discount_cents', 0),
        User::find(1), // üëà
        Item::make()
            -&gt;set('item_id', 12) 
            -&gt;set('description', 'Kit de Malas de Viagem') 
            -&gt;set('quantity', 1) 
            -&gt;set('price_cents', 25000));

// retorno autom√°tico üëá

Route::post('/payment/notification', function (Request $request) {
    $notification = PagHiper::pix(Cast::PixNotification) // üëà
        -&gt;notification($request);
})-&gt;name('paghiper.notification');
</code></pre>
<p>No exemplo acima, <code>$notification</code> ser√° uma inst√¢ncia da classe <code>PagHiperPixNotification</code> contendo o m√©todo <code>modelable()</code>.
Ao utilizar o m√©todo <code>$notification-&gt;modelable()</code> <code>PagHiper for Laravel</code> ir√° recuperar o usu√°rio automaticamente:</p>
<pre><code class="language-php">$user = $notification-&gt;modelable(); // üëà
</code></pre>
<p>No exemplo acima, <code>$user</code> ser√° uma inst√¢ncia de <code>\App\Models\User:1</code>.</p>
<h2 id="tratamento-de-excessao">Tratamento de Excess√£o</h2>
<p>Como √© de se esperar, caso haja algum erro na tentativa de capturar o modelador, uma excess√£o do tipo 
<code>NotificationModelNotFoundException</code> ou <code>ModelNotFoundException</code> ser√° lan√ßada. Para evitar esse comportamento
voc√™ pode utilizar o m√©todo <code>modelable</code> com o par√¢metro <code>false</code>:</p>
<pre><code class="language-php">$user = $notification-&gt;modelable(false); // üëà
</code></pre>
<p>Dessa forma, se houver algum erro ou o modelador n√£o for encontrado, o retorno ser√° <code>null</code>.</p>
<h2 id="casts">Casts</h2>
<p>Voc√™ tamb√©m pode usar os outros <a href="../../utilidades/casts/">casts</a> dispon√≠veis para transformar a resposta.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../cancelando/" class="btn btn-neutral float-left" title="Cancelando"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../../utilidades/casts/" class="btn btn-neutral float-right" title="Casts">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/devajmeireles/paghiper-for-laravel/" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../cancelando/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../../utilidades/casts/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../..";</script>
    <script src="../../../js/theme_extra.js"></script>
    <script src="../../../js/theme.js"></script>
      <script src="../../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(false);
        });
    </script>

</body>
</html>
